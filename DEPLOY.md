# Toast MX — Deploy to Vercel

## Prerequisites

- [Vercel account](https://vercel.com) (free tier works)
- GitHub/GitLab repo with this codebase pushed
- Anthropic API key (optional — for real AI extraction)

## Step 1: Create a Postgres Database

**Option A — Vercel Postgres (recommended)**

1. Go to [Vercel Dashboard](https://vercel.com/dashboard) → Storage → Create Database → Postgres
2. Name it `toast-mx-db` and select your region (closest to CDMX: `iad1` or `cle1`)
3. Copy the `DATABASE_URL` (pool connection string with `?pgbouncer=true&sslmode=require`)

**Option B — Neon (free tier)**

1. Go to [neon.tech](https://neon.tech) → Create Project
2. Copy the connection string: `postgresql://user:pass@ep-xxx.us-east-2.aws.neon.tech/neondb?sslmode=require`

## Step 2: Deploy to Vercel

### Via Vercel Dashboard (easiest)

1. Go to [vercel.com/new](https://vercel.com/new) → Import your Git repository
2. Framework: **Next.js** (auto-detected)
3. Set Environment Variables:

| Variable | Required | Value |
|---|---|---|
| `DATABASE_URL` | Yes | Your Postgres connection string |
| `BLOB_READ_WRITE_TOKEN` | Yes | Generated by Vercel Blob storage (see step 3) |
| `ANTHROPIC_API_KEY` | No | Your Anthropic API key |
| `TOAST_USE_REAL_AI` | No | `1` to enable Claude Vision extraction |

4. Build Command (auto from `package.json`):
   ```
   prisma generate && prisma migrate deploy && next build
   ```
5. Click **Deploy**

### Via CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Login
vercel login

# Link project
vercel link

# Set env vars
vercel env add DATABASE_URL
vercel env add BLOB_READ_WRITE_TOKEN
vercel env add ANTHROPIC_API_KEY        # optional
vercel env add TOAST_USE_REAL_AI        # optional

# Deploy
vercel --prod
```

## Step 3: Set up Vercel Blob (for invoice image uploads)

1. In Vercel Dashboard → your project → Storage → Connect Store → Blob
2. Create a new blob store (or connect existing)
3. This automatically adds `BLOB_READ_WRITE_TOKEN` to your project env vars
4. Redeploy if you added it after the first deploy:
   ```bash
   vercel --prod
   ```

## Step 4: Run Migrations

Migrations run automatically during build (`prisma migrate deploy`). If you need to run them manually:

```bash
# Using Vercel CLI with the production DATABASE_URL
DATABASE_URL="your-connection-string" npx prisma migrate deploy
```

## Step 5: Seed Demo Data (one-time)

After the first deploy, seed the database with demo data:

```bash
# Option A: Run locally pointing to production DB
DATABASE_URL="your-production-connection-string" npx prisma db seed

# Option B: Use Vercel CLI to run in production environment
vercel env pull .env.production.local
npx dotenv -e .env.production.local -- npx prisma db seed
```

**Warning**: The seed script deletes all existing data before inserting demo data. Only run this on a fresh database or when you want to reset.

## Step 6: Verify Deployment

1. Visit `https://your-app.vercel.app/api/health`
   - Should return `{ "status": "ok", "db": "connected", "restaurants": 1 }`
2. Visit `https://your-app.vercel.app`
   - Should redirect to `/scanner`
   - Paste the restaurant ID from the seed output (or from `/api/health`)

## Environment Variables Reference

| Variable | Description | Default |
|---|---|---|
| `DATABASE_URL` | PostgreSQL connection string | **Required** |
| `BLOB_READ_WRITE_TOKEN` | Vercel Blob token for file uploads | Falls back to local `/public/uploads` |
| `ANTHROPIC_API_KEY` | Anthropic API key for Claude Vision | Mock extraction used if absent |
| `TOAST_USE_REAL_AI` | Set to `1` to use real AI extraction | `0` (mock) |

## Troubleshooting

**Build fails with "prisma generate" error**
- Ensure `prisma` is in `dependencies` (not just `devDependencies`) in `package.json`
- The `postinstall` script runs `prisma generate` automatically

**"Foreign key constraint" on upload**
- Run the seed: `DATABASE_URL=... npx prisma db seed`
- Or create a restaurant manually via Prisma Studio: `DATABASE_URL=... npx prisma studio`

**Images not loading in production**
- Ensure `BLOB_READ_WRITE_TOKEN` is set and Vercel Blob storage is connected
- Old local paths (`/uploads/...`) won't work on Vercel — re-upload invoices after deploy

**502/504 errors on API routes**
- Check Vercel function logs in Dashboard → your project → Logs
- Common cause: Prisma client not generated — verify `postinstall` runs
